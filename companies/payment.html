<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Payment Page</title>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <style>
    body {
      background-color: #fff0f0;
      display: flex;
      justify-content: space-around;
      height: 100vh;
      gap: 10px;
      font-family: Arial, sans-serif;
    }

    .pay {
      text-align: center;
      margin-top: 100px;
      width: 30%;
      height: 250px;
      border: 2px solid #d63384;
      border-radius: 20px;
      padding: 30px;
    }
    .detail h1{
      text-align: center;
    }
    .detail{
      height: 770px;
      width: 40%;
      border: 2px solid #d63384;
      border-radius: 20px;
      padding: 10px 20px;
      overflow-y: auto;
    }
    h1 {
      color: #d63384;
    }
    p{
      font-size: 30px;
    }
    button {
      font-size: 20px;
      width: 150px;
      height: 50px;
      border-radius: 20px;
      background-color: #d63384;
      color: white;
      border: none;
      cursor: pointer;
    }

    button:hover {
      background-color: #c2185b;
    }
    #user-form {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #user-form input {
      width: 90%;
      padding: 12px;
      margin: 8px 0;
      border: 2px solid #d63384;
      border-radius: 10px;
      font-size: 16px;
      outline: none;
      transition: all 0.3s ease;
    }

    #user-form input:focus {
      border-color: #c2185b;
      box-shadow: 0 0 5px rgba(210, 50, 100, 0.5);
    }

    #user-form input::placeholder {
      color: #999;
      font-style: italic;
    }

    label {
      font-weight: bold;
      align-self: flex-start;
      margin-left: 5%;
      margin-top: 10px;
    }
  </style>

</head>

<body>
  <div class="detail">
    <h1>Enter Details</h1>
    <form id="user-form">
      <input type="text" name="fullName" id="fullName" required placeholder="Full Name" />
      <input type="email" name="email" id="email" required placeholder="Email" />
      <input type="text" name="mobile" id="mobile" required placeholder="Mobile Number" />

      <!-- Address Fields -->
      <input type="text" name="houseNumber" id="houseNumber" required placeholder="House Number" />
      <input type="text" name="street" id="street" required placeholder="Street" />
      <input type="text" name="locality" id="locality" required placeholder="Locality" />
      <input type="text" name="city" id="city" required placeholder="City" />
      <input type="text" name="district" id="district" required placeholder="District" />
      <input type="text" name="pincode" id="pincode" required placeholder="Pincode" />
      <input type="text" name="state" id="state" required placeholder="State" />

      <!-- Booking date -->
      <label for="bookingDate">Booking Date</label>
      <input type="date" name="bookingDate" id="bookingDate" required />

      <!-- <button type="button" id="rzp-button1">Book Now</button> -->
    </form>
  </div>

  <div class="pay">
    <h1>Payment Details</h1>
    <p id="plan"></p>
    <p id="price"></p>
    <button type="button" id="rzp-button1">Book Now</button>
  </div>

<script>
  const payBtn = document.getElementById('rzp-button1');
  const form = document.getElementById('user-form');

  function updateDisplay() {
    const plan = localStorage.getItem('selectedPlan');
    const price = localStorage.getItem('selectedPrice');

    if (plan && price) {
      document.getElementById('plan').innerText = `Plan: ${plan}`;
      document.getElementById('price').innerText = `Price: ₹${price}`;
    } else {
      document.getElementById('plan').innerText = 'No plan selected';
      document.getElementById('price').innerText = '';
    }
  }

  updateDisplay(); // Initial load

  payBtn.addEventListener('click', async () => {
    // Read latest plan & price inside button click
    const plan = localStorage.getItem('selectedPlan');
    const price = localStorage.getItem('selectedPrice');

    updateDisplay(); // Optional — refresh display again

    if (!form.checkValidity()) {
      alert('Please fill all required fields correctly.');
      return;
    }

    const formData = {
      fullName: form.fullName.value.trim(),
      email: form.email.value.trim(),
      mobile: form.mobile.value.trim(),
      address: {
        houseNumber: form.houseNumber.value.trim(),
        street: form.street.value.trim(),
        locality: form.locality.value.trim(),
        city: form.city.value.trim(),
        district: form.district.value.trim(),
        pincode: form.pincode.value.trim(),
        state: form.state.value.trim(),
      },
      bookingDate: form.bookingDate.value,
      plan: plan,
      price: Number(price),
    };

    try {
      const response = await fetch('http://localhost:5000/book', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData),
      });

      const result = await response.json();

      if (!response.ok) {
        alert(result.message || "Booking failed");
        return;
      }

      alert("Booking successful! Proceeding to payment.");

      var options = {
        key: "YOUR_RAZORPAY_KEY",
        amount: formData.price * 100,
        currency: "INR",
        name: "BookMyPlanner",
        description: `Payment for ${formData.plan}`, // FIXED HERE ✅
        handler: function (paymentResponse) {
          alert("Payment successful! Payment ID: " + paymentResponse.razorpay_payment_id);
        },
        prefill: {
          name: formData.fullName,
          email: formData.email,
          contact: formData.mobile,
        },
        theme: {
          color: "#d63384",
        },
      };

      var rzp = new Razorpay(options);
      rzp.open();

    } catch (err) {
      console.error(err);
      alert("Error during booking/payment. Please try again.");
    }
  });
</script>

</body>

</html>
